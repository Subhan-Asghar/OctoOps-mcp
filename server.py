import os
from github import Github, Auth
from git import Repo
from dotenv import load_dotenv
from mcp.server.fastmcp import FastMCP

# Initialize MCP Agent
mcp = FastMCP("OctoOps")

# Load environment variables
load_dotenv()

def git_auth() -> Github:
    access_token = os.getenv("GITHUB_TOKEN")
    if not access_token:
        raise EnvironmentError("Missing GITHUB_TOKEN in environment variables.")

    auth = Auth.Token(access_token)
    return Github(auth=auth)

@mcp.tool()
def git_clone(repo_url: str, dir_path: str, dir_name: str = "git_clone") -> str:
    """
    Clone a GitHub repository into the specified local directory.

    Args:
        repo_url (str): The URL of the GitHub repository to clone.
        dir_path (str): The base directory where the repo should be cloned.
        dir_name (str, optional): The folder name for the cloned repo.
                                  Can be user-defined or auto-generated by an LLM.

    Returns:
        str: A message indicating success or the reason for failure.
    """
    if not os.path.isdir(dir_path):
        return f"Invalid path: {dir_path} does not exist or is not a directory."

    try:
        full_path = os.path.join(dir_path, dir_name)
        Repo.clone_from(repo_url, full_path)
        return f"Repository cloned successfully to {full_path}"
    except Exception as e:
        return f"Git clone failed: {e}"

@mcp.tool()
def repo_list() -> list[str]:
    """
    Retrieve a list of repository names for the authenticated GitHub user.

    This function uses the GitHub personal access token from the environment
    variable `GITHUB_TOKEN` to authenticate via the GitHub API. It then fetches
    all repositories (public and private) associated with the authenticated user
    and returns a list of their names.

    Returns:
        list[str]: A list containing the names of all repositories belonging
                   to the authenticated user.
    """
    github_client = git_auth()
    
    return [repo.name for repo in github_client.get_user().get_repos()]